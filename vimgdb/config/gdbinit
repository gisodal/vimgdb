# vim: set filetype=python

# create vimgdb argv variable
python
#param = gdb.Parameter("_vimgdb_argv", gdb.COMMAND_NONE,gdb.PARAM_OPTIONAL_FILENAME)
class ArgvParameter(gdb.Parameter):
    def __init__(self):
        super(ArgvParameter, self).__init__("_vimgdb_argv",
            gdb.COMMAND_NONE, gdb.PARAM_STRING)
    def get_set_string(self):
        return "" #argv: "+self.value
    def get_show_string(self, _):
        return "" #argv: "+self.value

ArgvParameter()
end

# vimgdb interface
define _vimgdb
if $argc >= 1
    set _vimgdb_argv $arg0
else
    set _vimgdb_argv
end

python
def GetVimgdb():
    try:
        import sys
        import os

        sys.path.append(os.getcwd())
        from vimgdb import Vimgdb

        return Vimgdb()

    except ImportError:
        print("** vimgdb not found **")
        print("Python {0}.{1}.{2} could not find vimgdb in:".format(
                sys.version_info.major,
                sys.version_info.minor,
                sys.version_info.micro))

        for directory in sys.path:
            print("    {0}".format(directory))

        sys.exit(1)

try:
    vimgdb = GetVimgdb()
    argv = vimgdb.gdb.GetValue(vimgdb.gdb.argv)

    if argv == "register":
        vimgdb.Register()
    elif argv == "kill":
        vimgdb.Kill()
    elif argv == "disable":
        vimgdb.Disable()
    else:
        force_update = bool(argv == "force");
        cle_update = bool(argv != "breakpoints")
        vimgdb.Update(goto_cle=cle_update,force=force_update)

except KeyboardInterrupt:
    pass
except Exception as error:
    import traceback
    print("Vimgdb Exception: {0}".format(str(error)))
    print(traceback.format_exc())

end
end

_vimgdb register

define sync
    _vimgdb force
end

# gdb hooks
define hook-quit
    _vimgdb disable
end

define hookpost-up
    _vimgdb
end

define hookpost-down
    _vimgdb
end

define hookpost-kill
    _vimgdb kill
end
