# vim: set filetype=python

# create gdb option variable
python
param = gdb.Parameter("_vimgdb_argv", gdb.COMMAND_NONE,gdb.PARAM_OPTIONAL_FILENAME)
end

# vimgdb interface
define _vimgdb
if $argc >= 1
    set _vimgdb_argv $arg0
else
    set _vimgdb_argv
end

python
try:
    import sys
    import os

    sys.path.append(os.getcwd())
    from vimgdb import Vimgdb

    vimgdb = Vimgdb()
    argv = vimgdb.gdb.GetValue(vimgdb.gdb.argv)

    if argv == "disable":
        ret = vimgdb.Disable()
    elif argv == "main":
        if 'c++' in gdb.execute('show language', to_string=True):
            ret = vimgdb.Goto("main")
    else:
        force_update = bool(argv == "force");
        cle_update = bool(argv != "breakpoints")
        ret = vimgdb.Update(cle=cle_update,force=force_update)

    #if ret != 0:
    #    print("Vimgdb update failed")

except ImportError:
    print("** vimgdb not found **")
    print("Python {0}.{1}.{2} could not find vimgdb in:".format(
            sys.version_info.major,
            sys.version_info.minor,
            sys.version_info.micro))
    for directory in sys.path:
        print("    {0}".format(directory))

    sys.exit(1)
except KeyboardInterrupt:
    pass
except Exception as error:
    import traceback
    print("Vimgdb Exception: {0}".format(str(error)))
    print(traceback.format_exc())

end
end

define hookpost-file
    _vimgdb main
end

define sync
    _vimgdb force
end

# gdb hooks
define hook-quit
    _vimgdb disable
end

define hookpost-break
    _vimgdb breakpoints
end

define hookpost-tbreak
    _vimgdb breakpoints
end

define hookpost-disable
    _vimgdb breakpoints
end

define hookpost-enable
    _vimgdb breakpoints
end

define hookpost-clear
    _vimgdb breakpoints
end

define hook-stop
    _vimgdb
end

define hookpost-up
    _vimgdb
end

define hookpost-down
    _vimgdb
end

